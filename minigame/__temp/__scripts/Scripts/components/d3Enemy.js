"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var engine_1 = require("engine");
var collider_1 = require("../commons/collider");
var eventCenter_1 = require("../commons/eventCenter");
var d3Bullet_1 = require("./d3Bullet");
var d3Player_1 = require("./d3Player");
var randomBetween = function (min, max) {
    return Math.random() * (max - min) + min;
};
var D3Enemy = (function (_super) {
    tslib_1.__extends(D3Enemy, _super);
    function D3Enemy() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this.direction = engine_1.default.Vector3.ZERO.clone();
        _this.speed = randomBetween(3, 6);
        _this.sumTime = 0;
        _this.maxTime = 15;
        _this.hp = 5;
        _this.score = {
            collide: -2,
            dead: 1,
        };
        _this.rotationY = (Math.random() < 0.5 ? -1 : 1) * 0.05;
        _this.hurtParticle = null;
        _this.bound = engine_1.default.Vector3.createFromNumber(0.9 / 2, 0.5 / 2, 0.9 / 2);
        return _this;
    }
    D3Enemy_1 = D3Enemy;
    D3Enemy.prototype.onAwake = function () {
        this.direction.z = 1;
        this.hurtParticle = this.entity.transform.children[0].findChildByName("Hurt").entity.getComponent(engine_1.default.Particle);
        collider_1.default.watch(this, ["enemy"]);
    };
    D3Enemy.prototype.onUpdate = function (dt) {
        if (this.sumTime < this.maxTime) {
            this.sumTime += dt;
            this.entity.transform.position.x += this.direction.x * this.speed * dt;
            this.entity.transform.position.y += this.direction.y * this.speed * dt;
            this.entity.transform.position.z += this.direction.z * this.speed * dt;
            this.entity.transform.euler.y += this.rotationY;
        }
        else {
            this.removeEnemy();
        }
    };
    D3Enemy.prototype.onCollide = function (comp) {
        if (comp instanceof d3Player_1.default) {
            eventCenter_1.default.emit(eventCenter_1.default.HURT_PLAYER);
            eventCenter_1.default.emit(eventCenter_1.default.GET_SCORE, this.score.collide);
            this.removeEnemy();
        }
        else if (comp instanceof d3Bullet_1.default) {
            this.hp -= comp.attack;
            this.hurtParticle.emitter.start = true;
            if (this.hp <= 0) {
                eventCenter_1.default.emit(eventCenter_1.default.GET_SCORE, this.score.dead);
                this.removeEnemy();
            }
        }
    };
    D3Enemy.prototype.removeEnemy = function () {
        if (this.entity.transform) {
            var parentTransform = this.entity.transform.parent.entity.transform;
            parentTransform.removeChild(this.entity.transform);
            collider_1.default.unwatch(this);
            this.entity.destroy();
            D3Enemy_1.enemyCount--;
        }
    };
    D3Enemy.prototype.onDestroy = function () {
    };
    var D3Enemy_1;
    D3Enemy.enemyCount = 0;
    D3Enemy = D3Enemy_1 = tslib_1.__decorate([
        engine_1.default.decorators.serialize("D3Enemy")
    ], D3Enemy);
    return D3Enemy;
}(engine_1.default.Script));
exports.default = D3Enemy;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNjcmlwdHMvY29tcG9uZW50cy9kM0VuZW15LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLGlDQUE0QjtBQUM1QixnREFBMkM7QUFFM0Msc0RBQWlEO0FBQ2pELHVDQUFrQztBQUNsQyx1Q0FBa0M7QUFFbEMsSUFBTSxhQUFhLEdBQUcsVUFBQyxHQUFHLEVBQUUsR0FBRztJQUM3QixPQUFPLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsR0FBRyxHQUFHLENBQUM7QUFDM0MsQ0FBQyxDQUFDO0FBSUY7SUFBcUMsbUNBQWE7SUFBbEQ7UUFBQSxxRUEwRUM7UUF2RVEsZUFBUyxHQUFHLGdCQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN4QyxXQUFLLEdBQUcsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1QixhQUFPLEdBQUcsQ0FBQyxDQUFDO1FBQ1osYUFBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLFFBQUUsR0FBRyxDQUFDLENBQUM7UUFDUCxXQUFLLEdBQUc7WUFDYixPQUFPLEVBQUUsQ0FBQyxDQUFDO1lBQ1gsSUFBSSxFQUFFLENBQUM7U0FDUixDQUFDO1FBQ0ssZUFBUyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsRCxrQkFBWSxHQUFHLElBQUksQ0FBQztRQUNwQixXQUFLLEdBQUcsZ0JBQU0sQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxHQUFHLENBQUMsRUFBRSxHQUFHLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQzs7SUE0RDVFLENBQUM7Z0JBMUVvQixPQUFPO0lBZ0JuQix5QkFBTyxHQUFkO1FBRUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxD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QUFDLFNBQVMsQ0FBQyxTQUFTLENBQUM7T0FDbEIsT0FBTyxDQTBFM0I7SUFBRCxjQUFDO0NBMUVELEFBMEVDLENBMUVvQyxnQkFBTSxDQUFDLE1BQU0sR0EwRWpEO2tCQTFFb0IsT0FBTyIsImZpbGUiOiJTY3JpcHRzL2NvbXBvbmVudHMvZDNFbmVteS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBlbmdpbmUgZnJvbSBcImVuZ2luZVwiO1xuaW1wb3J0IENvbGxpZGVyIGZyb20gXCIuLi9jb21tb25zL2NvbGxpZGVyXCI7XG5pbXBvcnQgRGF0YUNlbnRlciBmcm9tIFwiLi4vY29tbW9ucy9kYXRhQ2VudGVyXCI7XG5pbXBvcnQgRXZlbnRDZW50ZXIgZnJvbSBcIi4uL2NvbW1vbnMvZXZlbnRDZW50ZXJcIjtcbmltcG9ydCBEM0J1bGxldCBmcm9tIFwiLi9kM0J1bGxldFwiO1xuaW1wb3J0IEQzUGxheWVyIGZyb20gXCIuL2QzUGxheWVyXCI7XG5cbmNvbnN0IHJhbmRvbUJldHdlZW4gPSAobWluLCBtYXgpID0+IHtcbiAgcmV0dXJuIE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSArIG1pbjtcbn07XG5cblxuQGVuZ2luZS5kZWNvcmF0b3JzLnNlcmlhbGl6ZShcIkQzRW5lbXlcIilcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEQzRW5lbXkgZXh0ZW5kcyBlbmdpbmUuU2NyaXB0IHtcblxuICBwdWJsaWMgc3RhdGljIGVuZW15Q291bnQgPSAwO1xuICBwdWJsaWMgZGlyZWN0aW9uID0gZW5naW5lLlZlY3RvcjMuWkVSTy5jbG9uZSgpO1xuICBwdWJsaWMgc3BlZWQgPSByYW5kb21CZXR3ZWVuKDMsIDYpO1xuICBwdWJsaWMgc3VtVGltZSA9IDA7XG4gIHB1YmxpYyBtYXhUaW1lID0gMTU7XG4gIHB1YmxpYyBocCA9IDU7XG4gIHB1YmxpYyBzY29yZSA9IHtcbiAgICBjb2xsaWRlOiAtMixcbiAgICBkZWFkOiAxLFxuICB9O1xuICBwdWJsaWMgcm90YXRpb25ZID0gKE1hdGgucmFuZG9tKCkgPCAwLjUgPyAtMSA6IDEpICogMC4wNTtcbiAgcHVibGljIGh1cnRQYXJ0aWNsZSA9IG51bGw7XG4gIHB1YmxpYyBib3VuZCA9IGVuZ2luZS5WZWN0b3IzLmNyZWF0ZUZyb21OdW1iZXIoMC45IC8gMiwgMC41IC8gMiwgMC45IC8gMik7XG5cbiAgcHVibGljIG9uQXdha2UoKSB7XG4gICAgLy8gY29uc29sZS5sb2coXCJvbkF3YWtlIEQzRW5lbXlcIik7XG4gICAgdGhpcy5kaXJlY3Rpb24ueiA9IDE7XG4gICAgdGhpcy5odXJ0UGFydGljbGUgPSB0aGlzLmVudGl0eS50cmFuc2Zvcm0uY2hpbGRyZW5bMF0uZmluZENoaWxkQnlOYW1lKFwiSHVydFwiKS5lbnRpdHkuZ2V0Q29tcG9uZW50KGVuZ2luZS5QYXJ0aWNsZSk7XG4gICAgQ29sbGlkZXIud2F0Y2godGhpcywgW1wiZW5lbXlcIl0pO1xuICB9XG5cbiAgcHVibGljIG9uVXBkYXRlKGR0KSB7XG4gICAgaWYgKHRoaXMuc3VtVGltZSA8IHRoaXMubWF4VGltZSkge1xuXG4gICAgICB0aGlzLnN1bVRpbWUgKz0gZHQ7XG5cbiAgICAgIC8vIGNvbnN0IHBsYXllciA9IERhdGFDZW50ZXIucGxheWVyRW50aXR5O1xuICAgICAgLy8gdGhpcy5kaXJlY3Rpb24ueCA9IHBsYXllci50cmFuc2Zvcm0ucG9zaXRpb24ueCAtIHRoaXMuZW50aXR5LnRyYW5zZm9ybS5wb3NpdGlvbi54O1xuICAgICAgLy8gdGhpcy5kaXJlY3Rpb24ueSA9IHBsYXllci50cmFuc2Zvcm0ucG9zaXRpb24ueSAtIHRoaXMuZW50aXR5LnRyYW5zZm9ybS5wb3NpdGlvbi55O1xuICAgICAgLy8gdGhpcy5kaXJlY3Rpb24ueiA9IHBsYXllci50cmFuc2Zvcm0ucG9zaXRpb24ueiAtIHRoaXMuZW50aXR5LnRyYW5zZm9ybS5wb3NpdGlvbi56O1xuICAgICAgLy8gdGhpcy5kaXJlY3Rpb24gPSB0aGlzLmRpcmVjdGlvbi5ub3JtYWxpemUoKTtcblxuICAgICAgdGhpcy5lbnRpdHkudHJhbnNmb3JtLnBvc2l0aW9uLnggKz0gdGhpcy5kaXJlY3Rpb24ueCAqIHRoaXMuc3BlZWQgKiBkdDtcbiAgICAgIHRoaXMuZW50aXR5LnRyYW5zZm9ybS5wb3NpdGlvbi55ICs9IHRoaXMuZGlyZWN0aW9uLnkgKiB0aGlzLnNwZWVkICogZHQ7XG4gICAgICB0aGlzLmVudGl0eS50cmFuc2Zvcm0ucG9zaXRpb24ueiArPSB0aGlzLmRpcmVjdGlvbi56ICogdGhpcy5zcGVlZCAqIGR0O1xuXG4gICAgICB0aGlzLmVudGl0eS50cmFuc2Zvcm0uZXVsZXIueSArPSB0aGlzLnJvdGF0aW9uWTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5yZW1vdmVFbmVteSgpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbkNvbGxpZGUoY29tcCkge1xuICAgIGlmIChjb21wIGluc3RhbmNlb2YgRDNQbGF5ZXIpIHtcbiAgICAgIC8vIGNvbnNvbGUubG9nKCdpc0NvbGxpZGVkIGVuZW15IHBsYXllcicpO1xuICAgICAgRXZlbnRDZW50ZXIuZW1pdChFdmVudENlbnRlci5IVVJUX1BMQVlFUik7XG4gICAgICBFdmVudENlbnRlci5lbWl0KEV2ZW50Q2VudGVyLkdFVF9TQ09SRSwgdGhpcy5zY29yZS5jb2xsaWRlKTtcbiAgICAgIHRoaXMucmVtb3ZlRW5lbXkoKTtcblxuICAgIH0gZWxzZSBpZiAoY29tcCBpbnN0YW5jZW9mIEQzQnVsbGV0KSB7XG4gICAgICB0aGlzLmhwIC09IGNvbXAuYXR0YWNrO1xuICAgICAgdGhpcy5odXJ0UGFydGljbGUuZW1pdHRlci5zdGFydCA9IHRydWU7XG4gICAgICBpZiAodGhpcy5ocCA8PSAwKSB7XG4gICAgICAgIEV2ZW50Q2VudGVyLmVtaXQoRXZlbnRDZW50ZXIuR0VUX1NDT1JFLCB0aGlzLnNjb3JlLmRlYWQpO1xuICAgICAgICB0aGlzLnJlbW92ZUVuZW15KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHJlbW92ZUVuZW15KCkge1xuICAgIGlmICh0aGlzLmVudGl0eS50cmFuc2Zvcm0pIHtcbiAgICAgIGNvbnN0IHBhcmVudFRyYW5zZm9ybSA9IHRoaXMuZW50aXR5LnRyYW5zZm9ybS5wYXJlbnQuZW50aXR5LnRyYW5zZm9ybTtcbiAgICAgIHBhcmVudFRyYW5zZm9ybS5yZW1vdmVDaGlsZCh0aGlzLmVudGl0eS50cmFuc2Zvcm0pO1xuICAgICAgQ29sbGlkZXIudW53YXRjaCh0aGlzKTtcbiAgICAgIHRoaXMuZW50aXR5LmRlc3Ryb3koKTtcbiAgICAgIEQzRW5lbXkuZW5lbXlDb3VudC0tO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBvbkRlc3Ryb3koKSB7XG4gICAgLy8gY29uc29sZS5sb2coJ29uRGVzdHJveSBlbmVteScpO1xuICB9XG59XG4iXX0=
